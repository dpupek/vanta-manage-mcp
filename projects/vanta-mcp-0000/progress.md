# Progress Log

## 2026-02-26
- [x] Implemented full OpenAPI parity generation (Manage + Audit + Connectors, 219 operations).
- [x] Added safe-mode mutation confirmation and workflow plan/execute gating.
- [x] Added compatibility read tools and specialized workflow tools.
- [x] Added test suite for parity, safety, multipart, and workflows.
- [x] Added docs bundle (`vanta-mcp-help`, migration, config examples, security).
- [x] Enabled Git-based `npx` execution via package `prepare` script (`npm run build`).
- [x] Added MCP help surface resources:
  - `resource://vanta-manage/help`
  - `resource://vanta-manage/cheatsheet`
  - `resource://vanta-manage/tool-catalog`
  - `resource://vanta-manage/workflow-playbooks`
  - `resource://vanta-manage/safety`
  - `resource://vanta-manage/troubleshooting`
- [x] Added playbook prompts:
  - `playbook_tool_selector`
  - `playbook_control_evidence`
  - `playbook_failing_controls_triage`
  - `playbook_vendor_triage`
  - `playbook_people_assets_vuln_triage`
  - `playbook_information_request_triage`
- [x] Added fallback `help` tool with resource/prompt index.
- [x] Refactored help generation so runtime help content and `docs/vanta-mcp-help.md` share one content model.
- [x] Added `npm run smoke:help-surface` to validate live MCP help-surface discovery/readability over stdio.
- [x] Ran credentialed smoke validation with:
  - `VANTA_ENV_FILE=C:\Users\dan.pupek\.vanta\vanta-credentials-ast.env`
  - Result: `PASS: MCP help surface smoke check succeeded.`
- [x] Added CI main release workflow (`.github/workflows/release-main-tag.yml`) to auto-tag on each `main` push.
- [x] Locked auto-release versioning contract:
  - `VERSION=1.0.${{ github.run_number }}`
  - `TAG=v1.0.<buildnumber>`
- [x] Added idempotency guard so existing tags skip release creation and exit successfully.
- [x] Added GitHub Release publication (`softprops/action-gh-release@v2`) for newly created tags.
- [x] Updated docs/config examples for tag-pinned Git `npx` usage:
  - `npx github:dpupek/vanta-manage-mcp#v1.0.<buildnumber>`
  - `npx git+https://github.com/dpupek/vanta-manage-mcp.git#v1.0.<buildnumber>`
- [x] Added credential loader support for both `VANTA_ENV_FILE` JSON and dotenv formats.
- [x] Enforced credential precedence: direct env vars override `VANTA_ENV_FILE`.
- [x] Added integration test gating helpers for live runs:
  - `VANTA_INTEGRATION_LIVE`
  - `VANTA_INTEGRATION_ALLOW_MUTATIONS`
  - `VANTA_INTEGRATION_REQUIRE_MUTATION`
  - `VANTA_INTEGRATION_TEST_CONTROL_ID`
  - `VANTA_INTEGRATION_TEST_TIMEOUT_MS`
- [x] Added mocked MCP end-to-end integration tests:
  - API error envelope resilience
  - OAuth 401 refresh/retry behavior
  - transport failure envelope behavior (`request_failed`)
- [x] Added live integration test suites for:
  - read + write document lifecycle (create/upload/read/delete)
  - optional control-evidence linkage verification
  - OAuth stability (repeat, concurrent, forced refresh)
- [x] Added live integration write-verification suites for:
  - vendor/finding lifecycle writes with readback assertions
  - vulnerability lifecycle writes (deactivate/reactivate/SLA acknowledgement) with readback assertions
- [x] Added mock integration write-verification suites for:
  - vendor/finding lifecycle write + readback flow
  - vulnerability lifecycle write + readback flow
- [x] Added manual CI workflow for live integration tests:
  - `.github/workflows/integration-live.yml`
  - `workflow_dispatch` only (no auto-run on push)
- [x] Added agent-centric error guidance contract:
  - error envelopes now support `error.agentHint`
  - compact actionable hints added for common error codes
  - explicit `rate_limit_exceeded` guidance points agents to retry/backoff + troubleshooting resource
  - new unit tests validate hint derivation and override behavior

## Gotchas (Carry Forward)
- Keep `_upstream/` and other temporary import folders out of lint/build scope.
- Keep `scripts/*.ts` covered by a dedicated TypeScript config (`tsconfig.scripts.json`) and ESLint project references.
- Always run `npm run verify:spec-parity` after OpenAPI or generator changes.
- Prefer script files over inline `node -e` for large generated markdown/docs to avoid escaping errors.
- For Git-based `npx`, keep `prepare` aligned with build output and `bin` path.
- `npm run build` rewrites `src/generated/manifest.generated.json` `generatedAt`; avoid committing timestamp-only churn unless intended.
- For new/updated MCP error surfaces, always include compact `agentHint` guidance when actionable next steps exist.

## 2026-02-27
- [x] Implemented breaking multipart upload contract migration:
  - Removed `contentBase64`/`filename` upload execution path.
  - Multipart upload tools now require local `filePath` (+ optional `mimeType`).
- [x] Added centralized upload validation and endpoint policy modules:
  - `src/uploads/types.ts`
  - `src/uploads/policy.ts`
  - `src/uploads/file-validation.ts`
  - `src/uploads/multipart.ts`
- [x] Enforced strict preflight checks before multipart writes:
  - path required (`file_path_required`)
  - file exists (`file_not_found`)
  - file readable (`file_not_readable`)
  - regular file only (`file_not_regular`)
  - allowed extension/MIME policy (`unsupported_file_type`)
- [x] Updated workflow upload interfaces to `filePath`:
  - `workflow_control_evidence`
  - `workflow_vendor_triage`
- [x] Updated help/prompts/user+dev docs to remove base64 guidance and document `filePath` behavior.
- [x] Added/updated tests for upload migration:
  - schema contract (`filePath` required for multipart file tools)
  - endpoint preflight error envelope tests
  - endpoint policy coverage (`upload-policy.test.ts`)
  - live read/write upload test moved to temp file `filePath` usage
- [x] Diagnosed and fixed live vendor/finding lifecycle failure:
  - Root cause: empty-body `204` responses with `application/json` caused JSON parse failure (`Unexpected end of JSON input`).
  - Fix: `parseResponsePayload` now treats `204/205` as `null` and parses JSON only when body text is non-empty.
  - Added regression in mock vendor/finding lifecycle for `204` + JSON content-type delete.
- [x] Validation results:
  - `npm run lint` passed.
  - `npm test` passed.
  - `npm run test:integration:mock` passed.
  - `npm run test:integration:live` passed (6/6), with transient OAuth 429 retries observed but recovered.
